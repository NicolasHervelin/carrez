var fs = require('fs');
var request = require('request');
var cheerio = require('cheerio');

exports.scrapLeboncoinJSON = function scrapLeboncoin(urlLeBoncoin,callback){
  var city, type, surface, price;
  var json = {city : "", type : "", surface : "", price : ""};

  request(urlLeBoncoin, function(error, response, html){ //belek au html
    if(!error){
      //console.log(html);
      var $ = cheerio.load(html);

      $('#adview > section > section > section.properties.lineNegative > div:nth-child(5) > h2').filter(function(){
        var data = $(this);
        price = data.text();
        price = price.replace(/\s/g,"");
        price = price.replace("Prix", "");
        price = price.replace("â‚¬", "");
        json.price = price;
      })

      $('#adview > section > section > section.properties.lineNegative > div.line.line_city > h2 > span.value').filter(function(){
        var data = $(this);
        city = data.text();
        cityLetter = city.replace(new RegExp("[^(a-zA-Z)]", "g"),"");
        cityLetter = cityLetter.toLowerCase();
        cityNumber = city.replace(new RegExp("[^(0-9)]", "g"),"");
        city = cityLetter + "-" + cityNumber;
        json.city = city;
      })

      $('#adview > section > section > section.properties.lineNegative > div:nth-child(7) > h2 > span.value').filter(function(){
        var data = $(this);
        type = data.text();
        type = type.toLowerCase();
        json.type = type;
      })

      $('#adview > section > section > section.properties.lineNegative > div:nth-child(9) > h2 > span.value').filter(function(){
        var data = $(this);
        surface = data.text();
        surface = surface.replace(" m2", "");
        json.surface = surface;
      })

      fs.writeFile('outputLeboncoin.json', JSON.stringify(json,null,4), function(err){
        console.log('File successfully written! - Check your project directory for the outputLeboncoin.json file');
      })
      callback(JSON.stringify(json,null,4));
    console.log(json);
    }
  });
}
