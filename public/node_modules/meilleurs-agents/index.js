var fs = require('fs');
var request = require('request');
var cheerio = require('cheerio');
var leboncoin = require('leboncoin');

exports.scrapMeilleursAgentsJSON = function scrapMeilleursAgents(urlMeilleursAgents, callback){
  var lowPriceApp, mediumPriceApp, highPriceApp, lowPriceHouse, mediumPriceHouse, highPriceHouse;
  var json = {lowPriceApp : "", mediumPriceApp : "", highPriceApp : "", lowPriceHouse : "", mediumPriceHouse : "", highPriceHouse : ""};

  request(urlMeilleursAgents, function(error, response, html){
    if(!error){
      var $ = cheerio.load(html);

      $('#synthese > div.prices-summary.baseline > div.prices-summary__values > div:nth-child(2) > div.small-4.medium-2.medium-offset-0.columns.prices-summary__cell--muted').filter(function(){
        var data = $(this);
        lowPriceApp = data.text();
        lowPriceApp = lowPriceApp.replace(/\s/g,"");
        lowPriceApp = lowPriceApp.replace("Prix", "");
        lowPriceApp = lowPriceApp.replace("€", "");
        json.lowPriceApp = lowPriceApp;
      })

      $('#synthese > div.prices-summary.baseline > div.prices-summary__values > div:nth-child(2) > div.small-4.medium-2.columns.prices-summary__cell--median').filter(function(){
        var data = $(this);
        mediumPriceApp = data.text();
        mediumPriceApp = mediumPriceApp.replace(/\s/g,"");
        mediumPriceApp = mediumPriceApp.replace("Prix", "");
        mediumPriceApp = mediumPriceApp.replace("€", "");
        json.mediumPriceApp = mediumPriceApp;
      })

      $('#synthese > div.prices-summary.baseline > div.prices-summary__values > div:nth-child(2) > div:nth-child(4)').filter(function(){
        var data = $(this);
        highPriceApp = data.text();
        highPriceApp = highPriceApp.replace(/\s/g,"");
        highPriceApp = highPriceApp.replace("Prix", "");
        highPriceApp = highPriceApp.replace("€", "");
        json.highPriceApp = highPriceApp;
      })

      $('#synthese > div.prices-summary.baseline > div.prices-summary__values > div:nth-child(3) > div.small-4.medium-2.medium-offset-0.columns.prices-summary__cell--muted').filter(function(){
        var data = $(this);
        lowPriceHouse = data.text();
        lowPriceHouse = lowPriceHouse.replace(/\s/g,"");
        lowPriceHouse = lowPriceHouse.replace("Prix", "");
        lowPriceHouse = lowPriceHouse.replace("€", "");
        json.lowPriceHouse = lowPriceHouse;
      })

      $('#synthese > div.prices-summary.baseline > div.prices-summary__values > div:nth-child(3) > div.small-4.medium-2.columns.prices-summary__cell--median').filter(function(){
        var data = $(this);
        mediumPriceHouse = data.text();
        mediumPriceHouse = mediumPriceHouse.replace(/\s/g,"");
        mediumPriceHouse = mediumPriceHouse.replace("Prix", "");
        mediumPriceHouse = mediumPriceHouse.replace("€", "");
        json.mediumPriceHouse = mediumPriceHouse;
      })

      $('#synthese > div.prices-summary.baseline > div.prices-summary__values > div:nth-child(3) > div:nth-child(4)').filter(function(){
        var data = $(this);
        highPriceHouse = data.text();
        highPriceHouse = highPriceHouse.replace(/\s/g,"");
        highPriceHouse = highPriceHouse.replace("Prix", "");
        highPriceHouse = highPriceHouse.replace("€", "");
        json.highPriceHouse = highPriceHouse;
      })

      fs.writeFile('outputMeilleursAgents.json', JSON.stringify(json,null,4), function(err){
        console.log('File successfully written! - Check your project directory for the outputMeilleursAgents.json file');
      })
      callback(JSON.stringify(json,null,4));
    console.log(json);
    }
  });
}

exports.isGoodDeal = function isGoodDeal(callbackLBC, callbackMA){
  var price = callbackLBC.price;
  var type = callbackLBC.type;
  var surface = callbackLBC.surface;
  var pricePerM = callbackLBC.price / callbackLBC.surface;
  var lowPriceApp = callbackMA.lowPriceApp;
  var mediumPriceApp = callbackMA.mediumPriceApp;
  var highPriceApp = callbackMA.highPriceApp;
  var lowPriceHouse = callbackMA.lowPriceHouse;
  var mediumPriceHouse = callbackMA.mediumPriceHouse;
  var highPriceHouse = callbackMA.highPriceHouse;
  var isgooddeal = 'YES, IT IS A GOOD DEAL !';
  var isNotgooddeal = 'NO ! IT IS UPPER THAN THE MEAN PRICE/M²';

  if(type == 'appartement'){
    if(lowPriceApp < pricePerM < highPriceApp){
      if(pricePerM > mediumPriceApp){
        isgooddeal = isNotgooddeal;
        return isgooddeal;
      }
    }
    else{
      isgooddeal = 'BE CAREFUL THIS BID IS PROBABLY FAKE !!!';
      return isgooddeal;
    }
  }
  else{
    if(lowPriceHouse < pricePerM < highPriceHouse){
      if(pricePerM > mediumPriceHouse){
        isgooddeal = isNotgooddeal;
        return isgooddeal;
      }
    }
    else{
      isgooddeal = 'BE CAREFUL THIS BID IS PROBABLY FAKE !!!';
      return isgooddeal;
    }
  }
}
